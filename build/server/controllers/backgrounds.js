// Generated by CoffeeScript 1.9.0
var Background, baseController, cozydb, fs, multiparty;

cozydb = require('cozydb');

multiparty = require('multiparty');

Background = require('../models/background');

fs = require('fs');

baseController = new cozydb.SimpleController({
  model: Background,
  reqParamID: 'backgroundid'
});

module.exports = {
  fetch: baseController.fetch,
  all: baseController.listAll,
  "delete": baseController.destroy,
  picture: baseController.sendBinary({
    filename: 'file'
  }),
  create: function(req, res, next) {
    var form;
    res.on('close', function() {
      return req.abort();
    });
    form = new multiparty.Form();
    return form.parse(req, function(err, fields, files) {
      var file;
      if (err) {
        return next(err);
      } else if ((files != null) && (files.picture != null) && files.picture.length > 0) {
        file = files.picture[0];
        return Background.create({}, function(err, background) {
          var data, id;
          if (err) {
            return next(err);
          }
          id = background.id;
          data = {
            name: 'file'
          };
          return Background.attachBinary(id, file.path, data, function(err) {
            return fs.unlink(file.path, function() {
              return res.send(background);
            });
          });
        });
      } else {
        return next(new Error('Can\'t change background, no file is attached.'));
      }
    });
  }
};
