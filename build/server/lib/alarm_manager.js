// Generated by CoffeeScript 1.8.0
var AlarmManager, CozyAdapter, RRule, log, moment, oneDay,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

CozyAdapter = require('jugglingdb-cozy-adapter');

RRule = require('rrule').RRule;

moment = require('moment-timezone');

log = require('printit')({
  prefix: 'alarm-manager'
});

oneDay = 24 * 60 * 60 * 1000;

module.exports = AlarmManager = (function() {
  AlarmManager.prototype.dailytimer = null;

  AlarmManager.prototype.timeouts = {};

  function AlarmManager(timezone, Alarm, Event, notificationhelper) {
    this.timezone = timezone;
    this.Alarm = Alarm;
    this.Event = Event;
    this.notificationhelper = notificationhelper;
    this.handleNotification = __bind(this.handleNotification, this);
    this.handleAlarm = __bind(this.handleAlarm, this);
    this.fetchAlarms = __bind(this.fetchAlarms, this);
    this.fetchAlarms();
  }

  AlarmManager.prototype.fetchAlarms = function() {
    this.dailytimer = setTimeout(this.fetchAlarms, oneDay);
    return this.Alarm.all((function(_this) {
      return function(err, alarms) {
        var alarm, _i, _len;
        for (_i = 0, _len = alarms.length; _i < _len; _i++) {
          alarm = alarms[_i];
          _this.addAlarmCounters(alarm);
        }
        return _this.Event.all(function(err, events) {
          var event, _j, _len1, _results;
          _results = [];
          for (_j = 0, _len1 = events.length; _j < _len1; _j++) {
            event = events[_j];
            _results.push(_this.addEventCounters(event));
          }
          return _results;
        });
      };
    })(this));
  };

  AlarmManager.prototype.clearTimeouts = function(id) {
    var timeout, _i, _len, _ref;
    if (this.timeouts[id] != null) {
      _ref = this.timeouts[id];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        timeout = _ref[_i];
        clearTimeout(timeout);
      }
      return delete this.timeouts[id];
    }
  };

  AlarmManager.prototype.handleAlarm = function(event, msg) {
    switch (event) {
      case "alarm.create":
      case "alarm.update":
        return this.Alarm.find(msg, (function(_this) {
          return function(err, alarm) {
            if (alarm != null) {
              return _this.addAlarmCounters(alarm);
            }
          };
        })(this));
      case "event.create":
      case "event.update":
        return this.Event.find(msg, (function(_this) {
          return function(err, event) {
            if (event != null) {
              return _this.addEventCounters(event);
            }
          };
        })(this));
      case "alarm.delete":
      case "event.delete":
        return this.clearTimeouts(msg);
    }
  };

  AlarmManager.prototype.addEventCounters = function(event) {
    var cozyAlarm, cozyAlarms, _i, _len, _ref, _results;
    if ((event.alarms != null) && ((_ref = event.alarms.items) != null ? _ref.length : void 0) > 0) {
      cozyAlarms = event.getAlarms(this.timezone);
      _results = [];
      for (_i = 0, _len = cozyAlarms.length; _i < _len; _i++) {
        cozyAlarm = cozyAlarms[_i];
        _results.push(this.addAlarmCounters(cozyAlarm));
      }
      return _results;
    }
  };

  AlarmManager.prototype.addAlarmCounters = function(alarm) {
    var delta, in24h, now, timeout, timezone, triggerDate, _base, _name, _ref;
    this.clearTimeouts(alarm._id);
    timezone = alarm.timezone || this.timezone;
    triggerDate = moment.tz(alarm.trigg, timezone);
    now = moment().tz(timezone);
    in24h = moment(now).add(1, 'days');
    if ((now.unix() <= (_ref = triggerDate.unix()) && _ref < in24h.unix())) {
      delta = triggerDate.valueOf() - now.valueOf();
      log.info("Notification in " + (delta / 1000) + " seconds.");
      if ((_base = this.timeouts)[_name = alarm._id] == null) {
        _base[_name] = [];
      }
      timeout = setTimeout(this.handleNotification.bind(this), delta, alarm);
      return this.timeouts[alarm._id].push(timeout);
    }
  };

  AlarmManager.prototype.handleNotification = function(alarm) {
    var data, resource, _ref, _ref1, _ref2;
    if ((_ref = alarm.action) === 'DISPLAY' || _ref === 'BOTH') {
      resource = alarm.related != null ? alarm.related : {
        app: 'calendar',
        url: "/#list"
      };
      this.notificationhelper.createTemporary({
        text: "Reminder: " + (alarm.description || ''),
        resource: resource
      });
    }
    if ((_ref1 = alarm.action) === 'EMAIL' || _ref1 === 'BOTH') {
      data = {
        from: "Cozy Agenda <no-reply@cozycloud.cc>",
        subject: "[Cozy-Agenda] Reminder",
        content: "Reminder: " + alarm.description
      };
      CozyAdapter.sendMailToUser(data, function(error, response) {
        if (error != null) {
          return log.error("Error while sending email -- " + error);
        }
      });
    }
    if ((_ref2 = alarm.action) !== 'EMAIL' && _ref2 !== 'DISPLAY' && _ref2 !== 'BOTH') {
      return log.error("UNKNOWN ACTION TYPE (" + alarm.action + ")");
    }
  };

  AlarmManager.prototype.iCalDurationToUnitValue = function(s) {
    var m, o;
    m = s.match(/(\d+)(W|D|H|M|S)/);
    o = {};
    o[m[2].toLowerCase()] = parseInt(m[1]);
    return o;
  };

  return AlarmManager;

})();
