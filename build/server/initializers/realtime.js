// Generated by CoffeeScript 1.8.0
var Alarm, AlarmManager, Application, CozyInstance, Event, Notification, NotificationsHelper, RealtimeAdapter, User, async, autostop, notifhelper;

async = require('async');

NotificationsHelper = require('cozy-notifications-helper');

RealtimeAdapter = require('cozy-realtime-adapter');

autostop = require('../lib/autostop');

AlarmManager = require('../lib/alarm_manager');

User = require('../models/user');

Alarm = require('../models/alarm');

Event = require('../models/event');

CozyInstance = require('../models/cozyinstance');

Application = require('../models/application');

Notification = require('../models/notification');

notifhelper = new NotificationsHelper('home');

module.exports = function(app, callback) {
  var eventsToForward, realtime;
  eventsToForward = ['notification.*', 'application.*', 'device.*'];
  realtime = RealtimeAdapter(app, eventsToForward);
  realtime.on('application.update', function(event, id) {
    return Application.find(id, function(err, app) {
      if (err) {
        return console.log(err.stack);
      }
      switch (app.state) {
        case 'broken':
          return notifhelper.createTemporary({
            text: "" + app.name + "'s installation failled.",
            resource: {
              app: 'home'
            }
          });
      }
    });
  });
  realtime.on('usage.application', function(event, name) {
    if (name !== 'home' && name !== 'proxy') {
      return autostop.restartTimeout(name);
    }
  });
  return async.parallel([User.all, CozyInstance.all], function(err, results) {
    var alarmManager, instance, instances, options, user, users;
    if ((err != null) || results.length !== 2) {
      console.info("Internal server error. Can't retrieve users or no user exists.");
    } else {
      users = results[0], instances = results[1];
      user = users[0];
      instance = instances[0];
      options = {
        timezone: user.timezone,
        locale: instance.locale,
        Event: Event,
        notificationHelper: notifhelper
      };
      alarmManager = new AlarmManager(options);
      app.alarmManager = alarmManager;
      realtime.on('event.*', alarmManager.handleAlarm);
    }
    return callback();
  });
};
