// Generated by CoffeeScript 1.8.0
var Alarm, AlarmManager, Application, Notification, NotificationsHelper, RealtimeAdapter, User, autostop, notifhelper;

NotificationsHelper = require('cozy-notifications-helper');

RealtimeAdapter = require('cozy-realtime-adapter');

autostop = require('../lib/autostop');

AlarmManager = require('../lib/alarm_manager');

User = require('../models/user');

Alarm = require('../models/alarm');

Application = require('../models/application');

Notification = require('../models/notification');

notifhelper = new NotificationsHelper('home');

module.exports = function(app, callback) {
  var realtime;
  realtime = RealtimeAdapter(app, ['notification.*', 'application.*']);
  realtime.on('application.update', function(event, id) {
    return Application.find(id, function(err, app) {
      if (err) {
        return console.log(err.stack);
      }
      switch (app.state) {
        case 'broken':
          return notifhelper.createTemporary({
            text: "" + app.name + "'s installation failled.",
            resource: {
              app: 'home'
            }
          });
      }
    });
  });
  realtime.on('usage.application', function(event, name) {
    if (name !== 'home' && name !== 'proxy') {
      return autostop.restartTimeout(name);
    }
  });
  return User.all(function(err, users) {
    var alarmManager, timezone;
    if ((err != null) || users.length === 0) {
      console.info("Internal server error. Can't retrieve users or no user exists.");
    } else {
      timezone = users[0].timezone;
      alarmManager = new AlarmManager(timezone, Alarm, notifhelper);
      app.alarmManager = alarmManager;
      realtime.on('alarm.*', alarmManager.handleAlarm);
    }
    return callback();
  });
};
